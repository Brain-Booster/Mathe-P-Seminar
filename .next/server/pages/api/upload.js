"use strict";(()=>{var e={};e.id=39,e.ids=[39],e.modules={2616:e=>{e.exports=require("formidable")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2048:e=>{e.exports=require("fs")},5315:e=>{e.exports=require("path")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,i){return i in r?r[i]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,i)):"function"==typeof r&&"default"===i?r:void 0}}})},6004:(e,r,i)=>{i.r(r),i.d(r,{config:()=>f,default:()=>c,routeModule:()=>m});var t={};i.r(t),i.d(t,{config:()=>p,default:()=>u});var s=i(1802),o=i(7153),l=i(6249),a=i(2616),n=i.n(a);i(5315);var d=i(8989);let p={api:{bodyParser:!1}};async function u(e,r){try{if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});let i=n()({multiples:!1,maxFileSize:104857600}),{fields:t,files:s}=await new Promise((r,t)=>{i.parse(e,(e,i,s)=>{if(e)return t(e);r({fields:i,files:s})})}),o=s.file,l=t.fileType;if(!l)return r.status(400).json({error:"File type is required"});let a=new d.X,p=await a.uploadFile(o,l,t.subPath||"");r.status(200).json({success:!0,fileUrl:p.url,filePath:p.path})}catch(e){console.error("Error in upload:",e),r.status(500).json({error:e.message})}}let c=(0,l.l)(t,"default"),f=(0,l.l)(t,"config"),m=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/upload",pathname:"/api/upload",bundlePath:"",filename:""},userland:t})},8989:(e,r,i)=>{i.d(r,{X:()=>a});var t=i(2048),s=i.n(t),o=i(5315),l=i.n(o);class a{constructor(){let e=l().join(process.cwd(),"public");this.imageDir=l().join(e,"uploads","images"),this.pdfDir=l().join(e,"uploads","pdfs"),this.modelDir=l().join(e,"uploads","models"),[this.imageDir,this.pdfDir,this.modelDir].forEach(e=>{s().existsSync(e)||s().mkdirSync(e,{recursive:!0})}),this.allowedFileTypes={images:["jpg","jpeg","png","webp"],pdfs:["pdf"],models:["glb","gltf","obj","stl","fbx"]},this.maxFileSize={images:10485760,pdfs:52428800,models:104857600}}async uploadFile(e,r,i=""){try{if(!e||!r)throw Error("File and fileType are required");let o=r;!this.allowedFileTypes[o]&&this.allowedFileTypes[`${o}s`]&&(o=`${o}s`);let a=e.originalFilename||l().basename(e.filepath),n=l().extname(a).toLowerCase().slice(1);if(!this.allowedFileTypes[o]?.includes(n))throw Error(`Invalid file type. Expected: ${this.allowedFileTypes[o]?.join(", ")||"unknown type"}`);if(!this.maxFileSize[o])throw Error("File type not supported");if(e.size>this.maxFileSize[o])throw Error(`File too large. Max size: ${this.maxFileSize[o]/1024/1024}MB`);let d=Date.now(),p=l().extname(a).toLowerCase(),u=l().basename(a,p).replace(/[^a-zA-Z0-9]/g,"_"),c=`${d}-${u}${p}`,f=this.getFilePath(o,i),m=l().join(f,c);console.log("FileHandler: saving file to",m);let h=l().dirname(m);if(s().existsSync(h)||s().mkdirSync(h,{recursive:!0}),await t.promises.rename(e.filepath,m),!s().existsSync(m))throw Error("File failed to save");return{path:l().relative(process.cwd(),m),url:this.getFileUrl(o,c),size:e.size,type:e.mimetype}}catch(e){throw console.error("Error uploading file:",e),e}}getFilePath(e,r=""){let i;if("images"===e)i=this.imageDir;else if("pdfs"===e)i=this.pdfDir;else if("models"===e)i=this.modelDir;else throw Error("Unsupported file type");let t=r?l().join(i,r):i;return s().existsSync(t)||s().mkdirSync(t,{recursive:!0}),t}getFileUrl(e,r){return`/api/serveUpload/${e}/${r}`}async serveFile(e,r){try{if(e.includes("..")){r.status(403).json({error:"Invalid path"});return}let i=l().join(process.cwd(),e);if(!s().existsSync(i)){r.status(404).json({error:"File not found"});return}let t=l().extname(e).toLowerCase(),o="application/octet-stream";".jpg"===t||".jpeg"===t?o="image/jpeg":".png"===t?o="image/png":".pdf"===t?o="application/pdf":".glb"===t?o="model/gltf-binary":".gltf"===t?o="model/gltf+json":".obj"===t?o="model/obj":".stl"===t?o="model/stl":".fbx"===t&&(o="model/fbx"),r.setHeader("Content-Type",o);{let e=Object.keys(this.allowedFileTypes).find(e=>this.allowedFileTypes[e].includes(t.slice(1)));r.setHeader("Cache-Control",{image:"public, max-age=31536000",pdf:"public, max-age=604800",model:"public, max-age=2592000"}[e]||"public, max-age=31536000")}r.setHeader("X-Content-Type-Options","nosniff"),r.setHeader("X-Frame-Options","DENY"),r.setHeader("X-XSS-Protection","1; mode=block");let a=s().createReadStream(i);a.pipe(r),a.on("error",e=>{console.error("Error reading file:",e),r.status(500).json({error:"Error reading file"})}),r.on("close",()=>{a.destroy()})}catch(e){console.error("Error serving file:",e),r.status(500).json({error:"Internal server error"})}}}},7153:(e,r)=>{var i;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,r,i)=>{e.exports=i(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var i=r(r.s=6004);module.exports=i})();